{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-credit-card me-2"></i>Payment Channels</h2>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                    <button class="btn btn-outline-success" onclick="exportChannels()">
                        <i class="fas fa-download me-1"></i>Export
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-primary mb-2" id="totalChannels">-</h4>
                    <p class="text-muted mb-0">Total Channels</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-warning mb-2" id="qrisChannels">-</h4>
                    <p class="text-muted mb-0">QRIS Codes</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-info mb-2" id="digitalWallets">-</h4>
                    <p class="text-muted mb-0">Digital Wallets</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-danger mb-2" id="highRiskChannels">-</h4>
                    <p class="text-muted mb-0">High Risk</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-3">
        <div class="col-md-4">
            <div class="input-group">
                <span class="input-group-text">
                    <i class="fas fa-search"></i>
                </span>
                <input type="text" class="form-control" id="searchChannels" 
                       placeholder="Search payment channels...">
            </div>
        </div>
        <div class="col-md-4">
            <select class="form-select" id="typeFilter">
                <option value="">All Types</option>
                <option value="qris">QRIS</option>
                <option value="ewallet">E-Wallet</option>
                <option value="bank">Bank Transfer</option>
                <option value="crypto">Cryptocurrency</option>
                <option value="other">Other</option>
            </select>
        </div>
        <div class="col-md-4">
            <select class="form-select" id="riskFilter">
                <option value="">All Risk Levels</option>
                <option value="1-3">Low Risk (1-3)</option>
                <option value="4-6">Medium Risk (4-6)</option>
                <option value="7-10">High Risk (7-10)</option>
            </select>
        </div>
    </div>

    <!-- Payment Channels Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-dark table-hover" id="channelsTable">
                    <thead>
                        <tr>
                            <th>Channel Info</th>
                            <th>Type</th>
                            <th>Risk Score</th>
                            <th>Associated URLs</th>
                            <th>First Detected</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="channelsTableBody">
                        <tr>
                            <td colspan="6" class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-3 text-muted">Loading payment channels...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Risk Distribution Chart -->
    <div class="row mt-4">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-pie me-2"></i>Risk Distribution</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="riskChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar me-2"></i>Channel Types</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="typeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Channel Detail Modal -->
<div class="modal fade" id="channelModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Payment Channel Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="channelModalBody">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" onclick="reportChannel()">
                    <i class="fas fa-flag me-1"></i>Report Suspicious
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadPaymentChannels();
    
    // Event listeners for filters
    document.getElementById('searchChannels').addEventListener('input', 
        CAKRA.utils.debounce(loadPaymentChannels, 500));
    document.getElementById('typeFilter').addEventListener('change', loadPaymentChannels);
    document.getElementById('riskFilter').addEventListener('change', loadPaymentChannels);
});

let currentChannels = [];
let riskChart = null;
let typeChart = null;

async function loadPaymentChannels() {
    const searchTerm = document.getElementById('searchChannels').value;
    const typeFilter = document.getElementById('typeFilter').value;
    const riskFilter = document.getElementById('riskFilter').value;
    
    const params = {
        limit: 500
    };
    
    if (typeFilter) params.type = typeFilter;
    
    if (riskFilter) {
        const [min, max] = riskFilter.split('-').map(Number);
        params.min_risk_score = min;
        if (max) params.max_risk_score = max;
    }
    
    try {
        const response = await fetch(`/api/v1/payment-channels?${new URLSearchParams(params)}`);
        const channels = await response.json();
        
        // Filter by search term locally
        currentChannels = searchTerm ? 
            channels.filter(channel => 
                JSON.stringify(channel).toLowerCase().includes(searchTerm.toLowerCase())
            ) : channels;
        
        displayChannels(currentChannels);
        updateStatistics(currentChannels);
        updateCharts(currentChannels);
        
    } catch (error) {
        console.error('Error loading payment channels:', error);
        showError('Failed to load payment channels');
    }
}

function displayChannels(channels) {
    const tbody = document.getElementById('channelsTableBody');
    
    if (channels.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-5 text-muted">
                    <i class="fas fa-credit-card fa-3x mb-3"></i>
                    <p>No payment channels found.</p>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = channels.map(channel => `
        <tr>
            <td>
                <div class="d-flex align-items-center">
                    <i class="fas ${getChannelIcon(channel.type)} text-primary me-2"></i>
                    <div>
                        <div class="fw-bold">${maskSensitiveInfo(channel.identifier)}</div>
                        <small class="text-muted">${channel.provider || 'Unknown'}</small>
                    </div>
                </div>
            </td>
            <td>
                <span class="badge ${getTypeBadgeClass(channel.type)}">
                    ${formatChannelType(channel.type)}
                </span>
            </td>
            <td>
                <div class="d-flex align-items-center">
                    <span class="fw-bold me-2">${channel.risk_score}/10</span>
                    ${getRiskIndicator(channel.risk_score)}
                </div>
            </td>
            <td>
                <span class="badge bg-info">${channel.associated_urls?.length || 0} URLs</span>
            </td>
            <td>
                <small>${CAKRA.utils.formatDate(channel.first_detected)}</small>
            </td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewChannelDetails(${channel.id})">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function updateStatistics(channels) {
    const total = channels.length;
    const qris = channels.filter(c => c.type === 'qris').length;
    const wallets = channels.filter(c => c.type === 'ewallet').length;
    const highRisk = channels.filter(c => c.risk_score >= 7).length;
    
    document.getElementById('totalChannels').textContent = total;
    document.getElementById('qrisChannels').textContent = qris;
    document.getElementById('digitalWallets').textContent = wallets;
    document.getElementById('highRiskChannels').textContent = highRisk;
}

function updateCharts(channels) {
    updateRiskChart(channels);
    updateTypeChart(channels);
}

function updateRiskChart(channels) {
    const riskData = {
        low: channels.filter(c => c.risk_score <= 3).length,
        medium: channels.filter(c => c.risk_score >= 4 && c.risk_score <= 6).length,
        high: channels.filter(c => c.risk_score >= 7).length
    };
    
    const canvas = document.getElementById('riskChart');
    
    if (riskChart) {
        riskChart.destroy();
    }
    
    riskChart = CAKRA.charts.createRiskChart(canvas, riskData);
}

function updateTypeChart(channels) {
    const typeData = {};
    channels.forEach(channel => {
        const type = formatChannelType(channel.type);
        typeData[type] = (typeData[type] || 0) + 1;
    });
    
    const canvas = document.getElementById('typeChart');
    
    if (typeChart) {
        typeChart.destroy();
    }
    
    typeChart = new Chart(canvas, {
        type: 'bar',
        data: {
            labels: Object.keys(typeData),
            datasets: [{
                label: 'Channels',
                data: Object.values(typeData),
                backgroundColor: '#0052cc',
                borderColor: '#004494',
                borderWidth: 1
            }]
        },
        options: {
            ...CAKRA.charts.getDefaultOptions(),
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { 
                        color: '#adb5bd',
                        stepSize: 1
                    },
                    grid: { color: '#495057' }
                },
                x: {
                    ticks: { color: '#adb5bd' },
                    grid: { color: '#495057' }
                }
            }
        }
    });
}

async function viewChannelDetails(channelId) {
    // In a real implementation, this would fetch detailed channel info
    const channel = currentChannels.find(c => c.id === channelId);
    if (!channel) return;
    
    const modal = new bootstrap.Modal(document.getElementById('channelModal'));
    const body = document.getElementById('channelModalBody');
    
    body.innerHTML = `
        <div class="row mb-4">
            <div class="col-md-8">
                <h5><i class="fas ${getChannelIcon(channel.type)} me-2"></i>${maskSensitiveInfo(channel.identifier)}</h5>
                <p class="text-muted">${channel.provider || 'Unknown Provider'}</p>
            </div>
            <div class="col-md-4 text-end">
                <div class="display-6 fw-bold ${getRiskColorClass(channel.risk_score)}">${channel.risk_score}/10</div>
                <div>Risk Score</div>
            </div>
        </div>
        
        <div class="row g-3">
            <div class="col-md-6">
                <div class="card bg-dark border-secondary">
                    <div class="card-body">
                        <h6><i class="fas fa-info-circle me-2"></i>Channel Information</h6>
                        <p><strong>Type:</strong> ${formatChannelType(channel.type)}</p>
                        <p><strong>Provider:</strong> ${channel.provider || 'Unknown'}</p>
                        <p><strong>First Detected:</strong> ${CAKRA.utils.formatDate(channel.first_detected)}</p>
                        <p><strong>Last Seen:</strong> ${CAKRA.utils.formatDate(channel.last_updated)}</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card bg-dark border-secondary">
                    <div class="card-body">
                        <h6><i class="fas fa-chart-line me-2"></i>Usage Statistics</h6>
                        <p><strong>Associated URLs:</strong> ${channel.associated_urls?.length || 0}</p>
                        <p><strong>Detection Count:</strong> ${channel.detection_count || 1}</p>
                        <p><strong>Confidence:</strong> ${channel.confidence || 'Unknown'}%</p>
                    </div>
                </div>
            </div>
            
            <div class="col-12">
                <div class="card bg-dark border-secondary">
                    <div class="card-header">
                        <h6><i class="fas fa-link me-2"></i>Associated URLs</h6>
                    </div>
                    <div class="card-body">
                        ${channel.associated_urls?.length ? 
                            channel.associated_urls.map(url => `
                                <div class="d-flex justify-content-between align-items-center py-2 border-bottom border-secondary">
                                    <span>${url}</span>
                                    <a href="/results?url=${encodeURIComponent(url)}" class="btn btn-sm btn-outline-primary">
                                        View Details
                                    </a>
                                </div>
                            `).join('') :
                            '<p class="text-muted">No associated URLs</p>'
                        }
                    </div>
                </div>
            </div>
        </div>
    `;
    
    modal.show();
}

function refreshData() {
    loadPaymentChannels();
    CAKRA.utils.showNotification('Payment channels refreshed', 'success');
}

function exportChannels() {
    if (currentChannels.length === 0) {
        CAKRA.utils.showNotification('No channels to export', 'warning');
        return;
    }
    
    const csv = generateChannelCSV(currentChannels);
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `payment-channels-${Date.now()}.csv`;
    a.click();
    URL.revokeObjectURL(url);
}

function generateChannelCSV(channels) {
    const headers = ['Identifier', 'Type', 'Provider', 'Risk Score', 'Associated URLs', 'First Detected'];
    const rows = channels.map(channel => [
        maskSensitiveInfo(channel.identifier),
        formatChannelType(channel.type),
        channel.provider || 'Unknown',
        channel.risk_score,
        channel.associated_urls?.length || 0,
        channel.first_detected
    ]);
    
    return [headers, ...rows].map(row => 
        row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
    ).join('\n');
}

function reportChannel() {
    CAKRA.utils.showNotification('Channel reported for review', 'success');
    // In a real implementation, this would send a report to administrators
}

// Helper functions
function getChannelIcon(type) {
    const icons = {
        'qris': 'fa-qrcode',
        'ewallet': 'fa-wallet',
        'bank': 'fa-university',
        'crypto': 'fa-bitcoin',
        'other': 'fa-credit-card'
    };
    return icons[type] || 'fa-credit-card';
}

function getTypeBadgeClass(type) {
    const classes = {
        'qris': 'bg-warning',
        'ewallet': 'bg-info',
        'bank': 'bg-primary',
        'crypto': 'bg-dark',
        'other': 'bg-secondary'
    };
    return classes[type] || 'bg-secondary';
}

function formatChannelType(type) {
    const types = {
        'qris': 'QRIS',
        'ewallet': 'E-Wallet',
        'bank': 'Bank Transfer',
        'crypto': 'Cryptocurrency',
        'other': 'Other'
    };
    return types[type] || 'Unknown';
}

function maskSensitiveInfo(identifier) {
    if (!identifier) return 'Unknown';
    
    // Mask sensitive information
    if (identifier.length > 8) {
        return identifier.substring(0, 4) + '****' + identifier.substring(identifier.length - 4);
    }
    return identifier;
}

function getRiskIndicator(score) {
    if (score >= 7) return '<i class="fas fa-exclamation-triangle text-danger"></i>';
    if (score >= 4) return '<i class="fas fa-exclamation-circle text-warning"></i>';
    return '<i class="fas fa-check-circle text-success"></i>';
}

function getRiskColorClass(score) {
    if (score >= 7) return 'text-danger';
    if (score >= 4) return 'text-warning';
    return 'text-success';
}

function showError(message) {
    const tbody = document.getElementById('channelsTableBody');
    tbody.innerHTML = `
        <tr>
            <td colspan="6" class="text-center py-5 text-danger">
                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                <p>${message}</p>
                <button class="btn btn-outline-primary" onclick="loadPaymentChannels()">
                    <i class="fas fa-redo me-1"></i>Retry
                </button>
            </td>
        </tr>
    `;
}
</script>
{% endblock %}